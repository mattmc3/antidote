#!/usr/bin/env zsh

### Statically source all bundles from the plugins file.
###
### usage: antidote load [-h|--help] [<bundlefile> [<staticfile>]]

setopt extended_glob

local opts
zparseopts -A opts -D -F -- h -help || return 1

if [[ -v opts[-h] ]] || [[ -v opts[--help] ]]; then
  antidote-help bundle
  return
fi

local bundlefile=$1
if [[ -z "$bundlefile" ]]; then
  zstyle -s ':antidote:bundle' file \
    'bundlefile' || bundlefile=${ZDOTDIR:-~}/.zsh_plugins.txt
fi
[[ -f "$bundlefile" ]] || touch "$bundlefile"

local staticfile=$2
if [[ -z "$staticfile" ]]; then
  zstyle -s ':antidote:static' file \
    'staticfile' || staticfile=${bundlefile:r}.zsh
fi
[[ "$staticfile" != "$bundlefile" ]] || staticfile="${bundlefile:r}.static.zsh"

# regenerate the static file based on whether the bundle file is newer
[[ $staticfile -nt $bundlefile ]] || antidote bundle <"$bundlefile" >|"$staticfile"
source "$staticfile"
