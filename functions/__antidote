#!/usr/bin/env zsh

### The controller for antidote functionality.

# The reason we use `__antidote` instead putting all of this in `antidote` directly,
# is that this allows the `antidote` command to be overridden via `antidote init`.
# The init command switches antidote from static mode to dynamic mode, but this
# core controller functionality remains.

setopt extended_glob
0=${(%):-%x}

local o_help o_version
zparseopts -D -M -- \
  h=o_help    -help=h    \
  v=o_version -version=v ||
  return 1

if (( $#o_version )); then
  local ver='1.5.1'
  local gitsha=$(git -C "${0:h:h}" rev-parse --short HEAD 2>/dev/null)
  [[ -z "$gitsha" ]] || ver="$ver ($gitsha)"
  echo "antidote version $ver"

elif (( $#o_help )); then
  antidote-help "$@"

elif [[ $# -eq 0 ]]; then
  antidote-help
  return 2

elif [[ "$1" = help ]]; then
  local manpage=${2:-antidote}
  antidote-help $manpage

elif (( $+functions[antidote-${1}] )); then
  local cmd=$1; shift
  antidote-${cmd} "$@"
  return $?

else
  echo >&2 "antidote: command not found '${1}'" && return 1
fi
